<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Ruby Compression: Từ Cơ Bản Đến Nâng Cao - Hướng Dẫn Toàn Diện | Keep Being Human</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ojisanchamchi.github.io/keep-being-human-dev/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ojisanchamchi.github.io/keep-being-human-dev/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ojisanchamchi.github.io/keep-being-human-dev/blog/ruby-compression-tu-co-ban-den-nang-cao/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Ruby Compression: Từ Cơ Bản Đến Nâng Cao - Hướng Dẫn Toàn Diện | Keep Being Human"><meta data-rh="true" name="description" content="Compression (nén dữ liệu) là một kỹ thuật quan trọng trong lập trình, giúp giảm kích thước file, tiết kiệm băng thông và tăng hiệu suất ứng dụng. Trong bài viết này, chúng ta sẽ khám phá các kỹ thuật compression trong Ruby từ cơ bản đến nâng cao, với các ví dụ thực tế và best practices."><meta data-rh="true" property="og:description" content="Compression (nén dữ liệu) là một kỹ thuật quan trọng trong lập trình, giúp giảm kích thước file, tiết kiệm băng thông và tăng hiệu suất ứng dụng. Trong bài viết này, chúng ta sẽ khám phá các kỹ thuật compression trong Ruby từ cơ bản đến nâng cao, với các ví dụ thực tế và best practices."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-07-24T10:20:47.000Z"><meta data-rh="true" property="article:author" content="https://github.com/ojisanchamchi"><meta data-rh="true" property="article:tag" content="Ruby,Compression,Gzip,ZIP,Performance,Optimization,Zlib,Streaming"><link data-rh="true" rel="icon" href="/keep-being-human-dev/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ojisanchamchi.github.io/keep-being-human-dev/blog/ruby-compression-tu-co-ban-den-nang-cao/"><link data-rh="true" rel="alternate" href="https://ojisanchamchi.github.io/keep-being-human-dev/blog/ruby-compression-tu-co-ban-den-nang-cao/" hreflang="en"><link data-rh="true" rel="alternate" href="https://ojisanchamchi.github.io/keep-being-human-dev/blog/ruby-compression-tu-co-ban-den-nang-cao/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://ojisanchamchi.github.io/keep-being-human-dev/blog/ruby-compression-tu-co-ban-den-nang-cao","mainEntityOfPage":"https://ojisanchamchi.github.io/keep-being-human-dev/blog/ruby-compression-tu-co-ban-den-nang-cao","url":"https://ojisanchamchi.github.io/keep-being-human-dev/blog/ruby-compression-tu-co-ban-den-nang-cao","headline":"Ruby Compression: Từ Cơ Bản Đến Nâng Cao - Hướng Dẫn Toàn Diện","name":"Ruby Compression: Từ Cơ Bản Đến Nâng Cao - Hướng Dẫn Toàn Diện","description":"Compression (nén dữ liệu) là một kỹ thuật quan trọng trong lập trình, giúp giảm kích thước file, tiết kiệm băng thông và tăng hiệu suất ứng dụng. Trong bài viết này, chúng ta sẽ khám phá các kỹ thuật compression trong Ruby từ cơ bản đến nâng cao, với các ví dụ thực tế và best practices.","datePublished":"2025-07-24T10:20:47.000Z","author":{"@type":"Person","name":"Dang Quang Minh","description":"Nhân viên oánh máy tính","url":"https://github.com/ojisanchamchi","image":"https://github.com/ojisanchamchi.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://ojisanchamchi.github.io/keep-being-human-dev/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/keep-being-human-dev/blog/rss.xml" title="Keep Being Human RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/keep-being-human-dev/blog/atom.xml" title="Keep Being Human Atom Feed"><link rel="stylesheet" href="/keep-being-human-dev/assets/css/styles.5d4f9dac.css">
<script src="/keep-being-human-dev/assets/js/runtime~main.46a0143c.js" defer="defer"></script>
<script src="/keep-being-human-dev/assets/js/main.d09cc611.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/keep-being-human-dev/img/logo.svg"><link rel="preload" as="image" href="https://github.com/ojisanchamchi.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_dyf1" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/keep-being-human-dev/"><div class="navbar__logo"><img src="/keep-being-human-dev/img/logo.svg" alt="Keep Being Human Logo" class="themedComponent_ogAL themedComponent--light__wdf"><img src="/keep-being-human-dev/img/logo.svg" alt="Keep Being Human Logo" class="themedComponent_ogAL themedComponent--dark_SEbq"></div><b class="navbar__title text--truncate">Keep Being Human</b></a><a class="navbar__item navbar__link" href="/keep-being-human-dev/docs/intro/">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/keep-being-human-dev/blog/">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/ojisanchamchi/keep-being-human-dev" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink__HqX"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_d9FJ colorModeToggle_OvZq"><button class="clean-btn toggleButton_YeW3 toggleButtonDisabled_axyx" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_Ubto lightToggleIcon_kqz0"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_Ubto darkToggleIcon_AfVN"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_Ubto systemToggleIcon_qH6u"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_NnjY"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_DTfW"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_jyhb thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_V_we margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_xV7s">2025</h3><ul class="sidebarItemList_WBAy clean-list"><li class="sidebarItem_gcTG"><a aria-current="page" class="sidebarItemLink_ordu sidebarItemLinkActive_NoCP" href="/keep-being-human-dev/blog/ruby-compression-tu-co-ban-den-nang-cao/">Ruby Compression: Từ Cơ Bản Đến Nâng Cao - Hướng Dẫn Toàn Diện</a></li><li class="sidebarItem_gcTG"><a class="sidebarItemLink_ordu" href="/keep-being-human-dev/blog/ruby-concurrency-mutexes-tu-co-ban-den-nang-cao/">Ruby Concurrency &amp; Mutexes: Từ Cơ Bản Đến Nâng Cao - Hướng Dẫn Toàn Diện</a></li><li class="sidebarItem_gcTG"><a class="sidebarItemLink_ordu" href="/keep-being-human-dev/blog/ruby-classes-modules-tu-co-ban-den-nang-cao/">Ruby Classes và Modules - Từ Cơ Bản Đến Nâng Cao Cho Developer</a></li><li class="sidebarItem_gcTG"><a class="sidebarItemLink_ordu" href="/keep-being-human-dev/blog/ruby-blocks-tu-co-ban-den-nang-cao/">Ruby Blocks - Từ Cơ Bản Đến Nâng Cao Cho Developer</a></li><li class="sidebarItem_gcTG"><a class="sidebarItemLink_ordu" href="/keep-being-human-dev/blog/huong-dan-benchmark-ruby/">Hướng Dẫn Toàn Diện Về Benchmark Trong Ruby - Từ Cơ Bản Đến Chuyên Sâu</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_lsAI">Ruby Compression: Từ Cơ Bản Đến Nâng Cao - Hướng Dẫn Toàn Diện</h1><div class="container_kuiJ margin-vert--md"><time datetime="2025-07-24T10:20:47.000Z">July 24, 2025</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_VoJj"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/keep-being-human-dev/blog/authors/admin/"><img class="avatar__photo authorImage_FcCi" src="https://github.com/ojisanchamchi.png" alt="Dang Quang Minh"></a><div class="avatar__intro authorDetails_YCfc"><div class="avatar__name"><a href="/keep-being-human-dev/blog/authors/admin/"><span class="authorName_AFC5">Dang Quang Minh</span></a></div><small class="authorTitle_e6Qj" title="Nhân viên oánh máy tính">Nhân viên oánh máy tính</small><div class="authorSocials_nZrJ"><a href="https://github.com/ojisanchamchi" target="_blank" rel="noopener noreferrer" class="authorSocialLink_E4St" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_E4St githubSvg_EOyk"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Compression (nén dữ liệu) là một kỹ thuật quan trọng trong lập trình, giúp giảm kích thước file, tiết kiệm băng thông và tăng hiệu suất ứng dụng. Trong bài viết này, chúng ta sẽ khám phá các kỹ thuật compression trong Ruby từ cơ bản đến nâng cao, với các ví dụ thực tế và best practices.</p>
<h2 class="anchor anchorWithStickyNavbar_aa2m" id="tại-sao-cần-compression">Tại Sao Cần Compression?<a href="#tại-sao-cần-compression" class="hash-link" aria-label="Direct link to Tại Sao Cần Compression?" title="Direct link to Tại Sao Cần Compression?">​</a></h2>
<p>Trước khi đi vào chi tiết, hãy hiểu tại sao compression lại quan trọng:</p>
<ul>
<li><strong>Tiết kiệm dung lượng lưu trữ</strong>: Giảm kích thước file trên disk</li>
<li><strong>Tăng tốc độ truyền tải</strong>: Giảm thời gian upload/download</li>
<li><strong>Giảm băng thông</strong>: Tiết kiệm chi phí network</li>
<li><strong>Cải thiện performance</strong>: Faster I/O operations</li>
<li><strong>Backup hiệu quả</strong>: Nén dữ liệu backup</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_aa2m" id="phần-1-cơ-bản---làm-quen-với-compression">Phần 1: Cơ Bản - Làm Quen Với Compression<a href="#phần-1-cơ-bản---làm-quen-với-compression" class="hash-link" aria-label="Direct link to Phần 1: Cơ Bản - Làm Quen Với Compression" title="Direct link to Phần 1: Cơ Bản - Làm Quen Với Compression">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_aa2m" id="11-nén-file-với-gzip">1.1 Nén File Với Gzip<a href="#11-nén-file-với-gzip" class="hash-link" aria-label="Direct link to 1.1 Nén File Với Gzip" title="Direct link to 1.1 Nén File Với Gzip">​</a></h3>
<p>Ruby cung cấp thư viện <code>Zlib</code> built-in để làm việc với compression. Đây là cách đơn giản nhất để nén một file:</p>
<div class="language-ruby codeBlockContainer_fd20 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_z5HD"><pre tabindex="0" class="prism-code language-ruby codeBlock_PbU4 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_ZkdA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">require</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;zlib&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(220, 220, 170)">compress_file_with_gzip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">source</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> destination</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">GzipWriter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">destination</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">gz</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">source</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;rb&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">file</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> chunk </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">16</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># Đọc từng chunk 16KB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        gz</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Đã nén </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">source</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)"> thành </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">destination</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Sử dụng</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">compress_file_with_gzip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;example.txt&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;example.txt.gz&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<p><strong>Giải thích:</strong></p>
<ul>
<li><code>Zlib::GzipWriter.open</code>: Mở file để ghi dữ liệu đã nén</li>
<li>Đọc file theo chunk để tránh load toàn bộ vào memory</li>
<li>Block tự động đóng file khi hoàn thành</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_aa2m" id="12-tạo-zip-archive">1.2 Tạo ZIP Archive<a href="#12-tạo-zip-archive" class="hash-link" aria-label="Direct link to 1.2 Tạo ZIP Archive" title="Direct link to 1.2 Tạo ZIP Archive">​</a></h3>
<p>Để tạo file ZIP chứa nhiều file, chúng ta sử dụng gem <code>rubyzip</code>:</p>
<div class="language-bash codeBlockContainer_fd20 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_z5HD"><pre tabindex="0" class="prism-code language-bash codeBlock_PbU4 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_ZkdA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">gem install rubyzip</span><br></span></code></pre></div></div>
<div class="language-ruby codeBlockContainer_fd20 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_z5HD"><pre tabindex="0" class="prism-code language-ruby codeBlock_PbU4 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_ZkdA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">require</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;zip&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(220, 220, 170)">create_zip_archive</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">files_to_zip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_zip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  Zip</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_zip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Zip</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token constant" style="color:rgb(100, 102, 149)">CREATE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">zipfile</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    files_to_zip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">each</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">filename</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)"># Kiểm tra file tồn tại</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">exist</span><span class="token operator" style="color:rgb(212, 212, 212)">?</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">filename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        zipfile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">basename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">filename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> filename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Đã thêm </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">filename</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)"> vào archive&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Cảnh báo: File </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">filename</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)"> không tồn tại&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Sử dụng</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">files </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;file1.txt&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;file2.txt&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;data.json&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">create_zip_archive</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;archive.zip&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<p><strong>Lưu ý quan trọng:</strong></p>
<ul>
<li>Luôn kiểm tra file tồn tại trước khi thêm vào ZIP</li>
<li><code>File.basename()</code> chỉ lấy tên file, không bao gồm đường dẫn</li>
<li>Sử dụng block để tự động đóng ZIP file</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_aa2m" id="phần-2-trung-cấp---kỹ-thuật-nâng-cao">Phần 2: Trung Cấp - Kỹ Thuật Nâng Cao<a href="#phần-2-trung-cấp---kỹ-thuật-nâng-cao" class="hash-link" aria-label="Direct link to Phần 2: Trung Cấp - Kỹ Thuật Nâng Cao" title="Direct link to Phần 2: Trung Cấp - Kỹ Thuật Nâng Cao">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_aa2m" id="21-nén-string-trong-memory">2.1 Nén String Trong Memory<a href="#21-nén-string-trong-memory" class="hash-link" aria-label="Direct link to 2.1 Nén String Trong Memory" title="Direct link to 2.1 Nén String Trong Memory">​</a></h3>
<p>Đối với dữ liệu tạm thời như JSON payload hoặc cache, nén trong memory sẽ nhanh hơn:</p>
<div class="language-ruby codeBlockContainer_fd20 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_z5HD"><pre tabindex="0" class="prism-code language-ruby codeBlock_PbU4 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_ZkdA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">require</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;zlib&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(220, 220, 170)">compress_string_in_memory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token symbol">level</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token constant" style="color:rgb(100, 102, 149)">BEST_COMPRESSION</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Nén dữ liệu</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  compressed </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">Deflate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">deflate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> level</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Kích thước gốc: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">data</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">bytesize</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)"> bytes&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Kích thước sau nén: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">compressed</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">bytesize</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)"> bytes&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Tỷ lệ nén: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content number" style="color:rgb(181, 206, 168)">1</span><span class="token string-literal interpolation content"> </span><span class="token string-literal interpolation content operator" style="color:rgb(212, 212, 212)">-</span><span class="token string-literal interpolation content"> compressed</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">bytesize</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">to_f </span><span class="token string-literal interpolation content operator" style="color:rgb(212, 212, 212)">/</span><span class="token string-literal interpolation content"> data</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">bytesize</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation content"> </span><span class="token string-literal interpolation content operator" style="color:rgb(212, 212, 212)">*</span><span class="token string-literal interpolation content"> </span><span class="token string-literal interpolation content number" style="color:rgb(181, 206, 168)">100</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">round</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content number" style="color:rgb(181, 206, 168)">2</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">%&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  compressed</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(220, 220, 170)">decompress_string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">compressed_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">Inflate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">inflate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">compressed_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Ví dụ với JSON data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">json_data </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token symbol">users</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1.</span><span class="token number" style="color:rgb(181, 206, 168)">.1000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">map </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">i</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token symbol">id</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token symbol">name</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;User </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">i</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token symbol">email</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;user</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">i</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">@example.com&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to_json</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">compressed </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> compress_string_in_memory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">json_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">decompressed </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> decompress_string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">compressed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Dữ liệu khôi phục chính xác: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">decompressed </span><span class="token string-literal interpolation content operator" style="color:rgb(212, 212, 212)">==</span><span class="token string-literal interpolation content"> json_data</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><br></span></code></pre></div></div>
<p><strong>Các mức độ nén:</strong></p>
<ul>
<li><code>Zlib::NO_COMPRESSION</code>: Không nén (0)</li>
<li><code>Zlib::BEST_SPEED</code>: Nén nhanh nhất (1)</li>
<li><code>Zlib::DEFAULT_COMPRESSION</code>: Cân bằng (6)</li>
<li><code>Zlib::BEST_COMPRESSION</code>: Nén tốt nhất (9)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_aa2m" id="22-nén-và-giải-nén-file-streaming">2.2 Nén và Giải Nén File Streaming<a href="#22-nén-và-giải-nén-file-streaming" class="hash-link" aria-label="Direct link to 2.2 Nén và Giải Nén File Streaming" title="Direct link to 2.2 Nén và Giải Nén File Streaming">​</a></h3>
<p>Phương pháp streaming giúp xử lý file lớn mà không cần load toàn bộ vào memory:</p>
<div class="language-ruby codeBlockContainer_fd20 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_z5HD"><pre tabindex="0" class="prism-code language-ruby codeBlock_PbU4 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_ZkdA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">require</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;zlib&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">FileCompressor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token constant" style="color:rgb(100, 102, 149)">CHUNK_SIZE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">16</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># 16KB chunks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition keyword" style="color:rgb(86, 156, 214)">self</span><span class="token method-definition punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token method-definition function" style="color:rgb(220, 220, 170)">compress_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;rb&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">input</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">GzipWriter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">gz</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> chunk </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token constant" style="color:rgb(100, 102, 149)">CHUNK_SIZE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          gz</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    original_size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    compressed_size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    compression_ratio </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> compressed_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to_f </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> original_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">round</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Nén hoàn thành:&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;  File gốc: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">format_bytes</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content">original_size</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;  File nén: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">format_bytes</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content">compressed_size</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;  Tỷ lệ nén: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">compression_ratio</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">%&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition keyword" style="color:rgb(86, 156, 214)">self</span><span class="token method-definition punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token method-definition function" style="color:rgb(220, 220, 170)">decompress_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">GzipReader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">gz</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;wb&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">output</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> chunk </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> gz</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token constant" style="color:rgb(100, 102, 149)">CHUNK_SIZE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Giải nén hoàn thành: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">output_path</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">private</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition keyword" style="color:rgb(86, 156, 214)">self</span><span class="token method-definition punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token method-definition function" style="color:rgb(220, 220, 170)">format_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    units </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;B&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;KB&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;MB&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;GB&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to_f</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    unit_index </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> size </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;&amp;</span><span class="token plain"> unit_index </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> units</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">length </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      size </span><span class="token operator" style="color:rgb(212, 212, 212)">/=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      unit_index </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">size</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">round</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content number" style="color:rgb(181, 206, 168)">2</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)"> </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">units</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string-literal interpolation content">unit_index</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Sử dụng</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">FileCompressor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">compress_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;large_file.log&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;large_file.log.gz&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">FileCompressor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">decompress_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;large_file.log.gz&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;restored_file.log&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_aa2m" id="phần-3-nâng-cao---kỹ-thuật-chuyên-nghiệp">Phần 3: Nâng Cao - Kỹ Thuật Chuyên Nghiệp<a href="#phần-3-nâng-cao---kỹ-thuật-chuyên-nghiệp" class="hash-link" aria-label="Direct link to Phần 3: Nâng Cao - Kỹ Thuật Chuyên Nghiệp" title="Direct link to Phần 3: Nâng Cao - Kỹ Thuật Chuyên Nghiệp">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_aa2m" id="31-tạo-targz-archives">3.1 Tạo TAR.GZ Archives<a href="#31-tạo-targz-archives" class="hash-link" aria-label="Direct link to 3.1 Tạo TAR.GZ Archives" title="Direct link to 3.1 Tạo TAR.GZ Archives">​</a></h3>
<p>Để tạo archive với metadata và permissions, kết hợp <code>Archive::Tar::Minitar</code> với <code>Zlib</code>:</p>
<div class="language-bash codeBlockContainer_fd20 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_z5HD"><pre tabindex="0" class="prism-code language-bash codeBlock_PbU4 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_ZkdA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">gem install minitar</span><br></span></code></pre></div></div>
<div class="language-ruby codeBlockContainer_fd20 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_z5HD"><pre tabindex="0" class="prism-code language-ruby codeBlock_PbU4 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_ZkdA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">require</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;zlib&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">require</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;archive/tar/minitar&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">include</span><span class="token plain"> Archive</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">Tar</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">TarGzArchiver</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition keyword" style="color:rgb(86, 156, 214)">self</span><span class="token method-definition punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token method-definition function" style="color:rgb(220, 220, 170)">create_archive</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sources</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token symbol">compression_level</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token constant" style="color:rgb(100, 102, 149)">BEST_COMPRESSION</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">GzipWriter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> compression_level</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">gzip</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      Minitar</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">Writer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">gzip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">tar</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        sources</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">each</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">path</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">directory</span><span class="token operator" style="color:rgb(212, 212, 212)">?</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Thêm thư mục: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">path</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            Minitar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pack_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> tar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">elsif</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">file</span><span class="token operator" style="color:rgb(212, 212, 212)">?</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Thêm file: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">path</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            Minitar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pack_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> tar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Cảnh báo: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">path</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)"> không tồn tại&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Tạo archive thành công: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">output_path</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition keyword" style="color:rgb(86, 156, 214)">self</span><span class="token method-definition punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token method-definition function" style="color:rgb(220, 220, 170)">extract_archive</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">archive_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> destination_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token builtin" style="color:rgb(86, 156, 214)">Dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">mkdir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">destination_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">unless</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">Dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">exist</span><span class="token operator" style="color:rgb(212, 212, 212)">?</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">destination_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">GzipReader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">archive_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">gzip</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      Minitar</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">Reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">gzip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">tar</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        tar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">each</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">entry</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          destination_path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">destination_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">full_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">directory</span><span class="token operator" style="color:rgb(212, 212, 212)">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">Dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">mkdir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">destination_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">unless</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">Dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">exist</span><span class="token operator" style="color:rgb(212, 212, 212)">?</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">destination_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">destination_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;wb&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">file</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Khôi phục permissions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">chmod</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">mode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> destination_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Giải nén: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">entry</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">full_name</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Giải nén hoàn thành vào: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">destination_dir</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Sử dụng</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">sources </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;app/&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;config/&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;README.md&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">TarGzArchiver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">create_archive</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sources</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;backup.tar.gz&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">TarGzArchiver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">extract_archive</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;backup.tar.gz&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;restored/&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_aa2m" id="32-streaming-large-file-compression">3.2 Streaming Large File Compression<a href="#32-streaming-large-file-compression" class="hash-link" aria-label="Direct link to 3.2 Streaming Large File Compression" title="Direct link to 3.2 Streaming Large File Compression">​</a></h3>
<p>Đối với file rất lớn, cần tối ưu hóa memory usage và performance:</p>
<div class="language-ruby codeBlockContainer_fd20 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_z5HD"><pre tabindex="0" class="prism-code language-ruby codeBlock_PbU4 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_ZkdA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">require</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;zlib&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">LargeFileCompressor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token constant" style="color:rgb(100, 102, 149)">DEFAULT_BUFFER_SIZE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">64</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># 64KB buffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(220, 220, 170)">initialize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token symbol">buffer_size</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token constant" style="color:rgb(100, 102, 149)">DEFAULT_BUFFER_SIZE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">@buffer_size</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> buffer_size</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(220, 220, 170)">compress_large_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token symbol">level</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token constant" style="color:rgb(100, 102, 149)">BEST_SPEED</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    start_time </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">Time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">now</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    bytes_processed </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;rb&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">input</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">GzipWriter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> level</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">gz</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> chunk </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@buffer_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          gz</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          bytes_processed </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">bytesize</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token comment" style="color:rgb(106, 153, 85)"># Progress reporting</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> bytes_processed </span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># Mỗi 1MB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            print </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;\rĐã xử lý: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">format_bytes</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content">bytes_processed</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    end_time </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">Time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">now</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    processing_time </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> end_time </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> start_time</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    original_size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    compressed_size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;\n\nThống kê nén:&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;  Thời gian xử lý: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">processing_time</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">round</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content number" style="color:rgb(181, 206, 168)">2</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">s&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;  Tốc độ: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">format_bytes</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content">original_size </span><span class="token string-literal interpolation content operator" style="color:rgb(212, 212, 212)">/</span><span class="token string-literal interpolation content"> processing_time</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">/s&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;  Kích thước gốc: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">format_bytes</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content">original_size</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;  Kích thước nén: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">format_bytes</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content">compressed_size</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;  Tỷ lệ nén: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content number" style="color:rgb(181, 206, 168)">1</span><span class="token string-literal interpolation content"> </span><span class="token string-literal interpolation content operator" style="color:rgb(212, 212, 212)">-</span><span class="token string-literal interpolation content"> compressed_size</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">to_f </span><span class="token string-literal interpolation content operator" style="color:rgb(212, 212, 212)">/</span><span class="token string-literal interpolation content"> original_size</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation content"> </span><span class="token string-literal interpolation content operator" style="color:rgb(212, 212, 212)">*</span><span class="token string-literal interpolation content"> </span><span class="token string-literal interpolation content number" style="color:rgb(181, 206, 168)">100</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">round</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content number" style="color:rgb(181, 206, 168)">2</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">%&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">private</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(220, 220, 170)">format_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    units </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;B&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;KB&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;MB&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;GB&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;TB&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to_f</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    unit_index </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> size </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;&amp;</span><span class="token plain"> unit_index </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> units</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">length </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      size </span><span class="token operator" style="color:rgb(212, 212, 212)">/=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      unit_index </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">size</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">round</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content number" style="color:rgb(181, 206, 168)">2</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)"> </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">units</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string-literal interpolation content">unit_index</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Sử dụng</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">compressor </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">LargeFileCompressor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token symbol">buffer_size</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">128</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># 128KB buffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">compressor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">compress_large_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;huge_video.mp4&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;huge_video.mp4.gz&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_aa2m" id="phần-4-expert-level---kỹ-thuật-chuyên-gia">Phần 4: Expert Level - Kỹ Thuật Chuyên Gia<a href="#phần-4-expert-level---kỹ-thuật-chuyên-gia" class="hash-link" aria-label="Direct link to Phần 4: Expert Level - Kỹ Thuật Chuyên Gia" title="Direct link to Phần 4: Expert Level - Kỹ Thuật Chuyên Gia">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_aa2m" id="41-custom-streaming-chunked-compression">4.1 Custom Streaming Chunked Compression<a href="#41-custom-streaming-chunked-compression" class="hash-link" aria-label="Direct link to 4.1 Custom Streaming Chunked Compression" title="Direct link to 4.1 Custom Streaming Chunked Compression">​</a></h3>
<p>Đây là kỹ thuật nâng cao nhất, cho phép kiểm soát hoàn toàn quá trình compression:</p>
<div class="language-ruby codeBlockContainer_fd20 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_z5HD"><pre tabindex="0" class="prism-code language-ruby codeBlock_PbU4 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_ZkdA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">require</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;zlib&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">AdvancedStreamCompressor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token constant" style="color:rgb(100, 102, 149)">CHUNK_SIZE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">16</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># 16KB per chunk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition keyword" style="color:rgb(86, 156, 214)">self</span><span class="token method-definition punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token method-definition function" style="color:rgb(220, 220, 170)">compress_with_metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token symbol">level</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token constant" style="color:rgb(100, 102, 149)">BEST_COMPRESSION</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;rb&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">infile</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;wb&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">outfile</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        gz </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token class-name" style="color:rgb(78, 201, 176)">GzipWriter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">outfile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> level</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Tùy chỉnh Gzip header với metadata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        gz</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">orig_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">basename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        gz</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">mtime </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">mtime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to_i</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        gz</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">comment </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Compressed by Ruby Advanced Compressor&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Streaming compression với progress tracking</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        total_size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        processed </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> chunk </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> infile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token constant" style="color:rgb(100, 102, 149)">CHUNK_SIZE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          gz</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          processed </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">bytesize</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token comment" style="color:rgb(106, 153, 85)"># Progress bar</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          progress </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">processed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to_f </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> total_size </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">round</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          print </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;\rProgress: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">progress</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">% [</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">format_progress_bar</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content">progress</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        gz</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">close</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;\nHoàn thành!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition keyword" style="color:rgb(86, 156, 214)">self</span><span class="token method-definition punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token method-definition function" style="color:rgb(220, 220, 170)">benchmark_compression_levels</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Benchmark các mức độ nén cho file: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content builtin" style="color:rgb(86, 156, 214)">File</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">basename</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content">input_path</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;=&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    levels </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token constant" style="color:rgb(100, 102, 149)">BEST_SPEED</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;BEST_SPEED&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token constant" style="color:rgb(100, 102, 149)">DEFAULT_COMPRESSION</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;DEFAULT&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token constant" style="color:rgb(100, 102, 149)">BEST_COMPRESSION</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;BEST_COMPRESSION&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    original_size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    levels</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">each</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">level</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> name</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      output_path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">input_path</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">.</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">name</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">downcase</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">.gz&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      start_time </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">Time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">now</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      compress_with_metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token symbol">level</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> level</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      end_time </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">Time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">now</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      compressed_size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      compression_ratio </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> compressed_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to_f </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> original_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">round</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      processing_time </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">end_time </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> start_time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">round</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;\n</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">name</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">:&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;  Thời gian: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">processing_time</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">s&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;  Kích thước: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">format_bytes</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content">compressed_size</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;  Tỷ lệ nén: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">compression_ratio</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">%&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;  Tốc độ: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">format_bytes</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content">original_size </span><span class="token string-literal interpolation content operator" style="color:rgb(212, 212, 212)">/</span><span class="token string-literal interpolation content"> processing_time</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">/s&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      puts</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)"># Cleanup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">delete</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">private</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition keyword" style="color:rgb(86, 156, 214)">self</span><span class="token method-definition punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token method-definition function" style="color:rgb(220, 220, 170)">format_progress_bar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">progress</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token symbol">width</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">30</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    filled </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">progress </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100.0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> width</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">round</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    empty </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> width </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> filled</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;█&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> filled </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;░&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> empty</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition keyword" style="color:rgb(86, 156, 214)">self</span><span class="token method-definition punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token method-definition function" style="color:rgb(220, 220, 170)">format_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    units </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;B&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;KB&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;MB&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;GB&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;TB&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to_f</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    unit_index </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> size </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;&amp;</span><span class="token plain"> unit_index </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> units</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">length </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      size </span><span class="token operator" style="color:rgb(212, 212, 212)">/=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      unit_index </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">size</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">round</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content number" style="color:rgb(181, 206, 168)">2</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)"> </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">units</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string-literal interpolation content">unit_index</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Sử dụng</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">AdvancedStreamCompressor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">benchmark_compression_levels</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;large_dataset.csv&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_aa2m" id="42-multi-threaded-compression">4.2 Multi-threaded Compression<a href="#42-multi-threaded-compression" class="hash-link" aria-label="Direct link to 4.2 Multi-threaded Compression" title="Direct link to 4.2 Multi-threaded Compression">​</a></h3>
<p>Đối với hệ thống multi-core, có thể tăng tốc bằng parallel processing:</p>
<div class="language-ruby codeBlockContainer_fd20 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_z5HD"><pre tabindex="0" class="prism-code language-ruby codeBlock_PbU4 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_ZkdA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">require</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;zlib&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">require</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;thread&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">ParallelCompressor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition keyword" style="color:rgb(86, 156, 214)">self</span><span class="token method-definition punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token method-definition function" style="color:rgb(220, 220, 170)">compress_multiple_files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token symbol">max_threads</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token builtin" style="color:rgb(86, 156, 214)">Dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">mkdir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">unless</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">Dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">exist</span><span class="token operator" style="color:rgb(212, 212, 212)">?</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    queue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">Queue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    file_list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">each</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">file</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> queue </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;&lt;</span><span class="token plain"> file </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    threads </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    mutex </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">Mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    completed </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    max_threads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">times </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      threads </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;&lt;</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">Thread</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">!</span><span class="token plain">queue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">empty</span><span class="token operator" style="color:rgb(212, 212, 212)">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            file_path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> queue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pop</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># non-blocking pop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output_path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content builtin" style="color:rgb(86, 156, 214)">File</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">basename</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content">file_path</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">.gz&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            compress_single_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">synchronize </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              completed </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Hoàn thành </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">completed</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">/</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">file_list</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">length</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content builtin" style="color:rgb(86, 156, 214)">File</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">basename</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal interpolation content">file_path</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">rescue</span><span class="token plain"> ThreadError</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Queue empty</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    threads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">each</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token symbol">:join</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Nén song song hoàn thành!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">private</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition keyword" style="color:rgb(86, 156, 214)">self</span><span class="token method-definition punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token method-definition function" style="color:rgb(220, 220, 170)">compress_single_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">GzipWriter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token constant" style="color:rgb(100, 102, 149)">BEST_SPEED</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">gz</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;rb&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">file</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> chunk </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">16</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          gz</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Sử dụng</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">files </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">Dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">glob</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;logs/*.log&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">ParallelCompressor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">compress_multiple_files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;compressed_logs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token symbol">max_threads</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_aa2m" id="best-practices-và-lưu-ý">Best Practices và Lưu Ý<a href="#best-practices-và-lưu-ý" class="hash-link" aria-label="Direct link to Best Practices và Lưu Ý" title="Direct link to Best Practices và Lưu Ý">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_aa2m" id="1-chọn-mức-độ-nén-phù-hợp">1. Chọn Mức Độ Nén Phù Hợp<a href="#1-chọn-mức-độ-nén-phù-hợp" class="hash-link" aria-label="Direct link to 1. Chọn Mức Độ Nén Phù Hợp" title="Direct link to 1. Chọn Mức Độ Nén Phù Hợp">​</a></h3>
<div class="language-ruby codeBlockContainer_fd20 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_z5HD"><pre tabindex="0" class="prism-code language-ruby codeBlock_PbU4 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_ZkdA"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Cho real-time applications</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">level </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token constant" style="color:rgb(100, 102, 149)">BEST_SPEED</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Cho storage/backup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">level </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token constant" style="color:rgb(100, 102, 149)">BEST_COMPRESSION</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Cân bằng tốc độ và kích thước</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">level </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token constant" style="color:rgb(100, 102, 149)">DEFAULT_COMPRESSION</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_aa2m" id="2-memory-management">2. Memory Management<a href="#2-memory-management" class="hash-link" aria-label="Direct link to 2. Memory Management" title="Direct link to 2. Memory Management">​</a></h3>
<div class="language-ruby codeBlockContainer_fd20 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_z5HD"><pre tabindex="0" class="prism-code language-ruby codeBlock_PbU4 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_ZkdA"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># ✅ Tốt: Streaming với chunk size hợp lý</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token constant" style="color:rgb(100, 102, 149)">CHUNK_SIZE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">16</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># 16KB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># ❌ Tránh: Load toàn bộ file vào memory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">data </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">large_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># Có thể gây OOM</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_aa2m" id="3-error-handling">3. Error Handling<a href="#3-error-handling" class="hash-link" aria-label="Direct link to 3. Error Handling" title="Direct link to 3. Error Handling">​</a></h3>
<div class="language-ruby codeBlockContainer_fd20 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_z5HD"><pre tabindex="0" class="prism-code language-ruby codeBlock_PbU4 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_ZkdA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(220, 220, 170)">safe_compress</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">GzipWriter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">gz</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&#x27;rb&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">do</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain">file</span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> chunk </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">16</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          gz</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Nén thành công: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">output_path</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">rescue</span><span class="token plain"> Errno</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token constant" style="color:rgb(100, 102, 149)">ENOENT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Lỗi: File không tồn tại - </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">input_path</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">rescue</span><span class="token plain"> Zlib</span><span class="token double-colon punctuation" style="color:rgb(212, 212, 212)">::</span><span class="token plain">Error </span><span class="token operator" style="color:rgb(212, 212, 212)">=&gt;</span><span class="token plain"> e</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Lỗi compression: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">e</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">message</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">delete</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">exist</span><span class="token operator" style="color:rgb(212, 212, 212)">?</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">rescue</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=&gt;</span><span class="token plain"> e</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    puts </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Lỗi không xác định: </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">#{</span><span class="token string-literal interpolation content">e</span><span class="token string-literal interpolation content punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-literal interpolation content">message</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">end</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_aa2m" id="4-performance-tips">4. Performance Tips<a href="#4-performance-tips" class="hash-link" aria-label="Direct link to 4. Performance Tips" title="Direct link to 4. Performance Tips">​</a></h3>
<ul>
<li>Sử dụng buffer size là bội số của 2 (16KB, 32KB, 64KB)</li>
<li>Chọn compression level phù hợp với use case</li>
<li>Với file lớn, ưu tiên <code>BEST_SPEED</code> để giảm CPU usage</li>
<li>Monitor memory usage khi xử lý file lớn</li>
<li>Sử dụng parallel processing cho multiple files</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_aa2m" id="kết-luận">Kết Luận<a href="#kết-luận" class="hash-link" aria-label="Direct link to Kết Luận" title="Direct link to Kết Luận">​</a></h2>
<p>Compression trong Ruby là một kỹ năng quan trọng cho mọi developer. Từ việc nén file đơn giản với Gzip đến các kỹ thuật streaming phức tạp, Ruby cung cấp đầy đủ công cụ để xử lý mọi tình huống.</p>
<p>Những điểm chính cần nhớ:</p>
<ol>
<li><strong>Cơ bản</strong>: Sử dụng <code>Zlib</code> cho Gzip và <code>rubyzip</code> cho ZIP</li>
<li><strong>Trung cấp</strong>: Streaming để xử lý file lớn, nén in-memory cho dữ liệu tạm</li>
<li><strong>Nâng cao</strong>: TAR.GZ archives với metadata, parallel processing</li>
<li><strong>Expert</strong>: Custom streaming với progress tracking và optimization</li>
</ol>
<p>Hãy lựa chọn kỹ thuật phù hợp với nhu cầu cụ thể của dự án và luôn cân nhắc giữa tốc độ nén và kích thước file đầu ra.</p>
<p>Chúc các bạn áp dụng thành công các kỹ thuật compression trong Ruby! 🚀</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_BgrL padding--none margin-left--sm"><li class="tag_cZsL"><a rel="tag" title="Content related to Ruby programming language" class="tag_xPz1 tagRegular_FZN5" href="/keep-being-human-dev/blog/tags/ruby/">Ruby</a></li><li class="tag_cZsL"><a rel="tag" title="Content about data compression techniques and algorithms" class="tag_xPz1 tagRegular_FZN5" href="/keep-being-human-dev/blog/tags/compression/">Compression</a></li><li class="tag_cZsL"><a rel="tag" title="Content related to Gzip compression format and usage" class="tag_xPz1 tagRegular_FZN5" href="/keep-being-human-dev/blog/tags/gzip/">Gzip</a></li><li class="tag_cZsL"><a rel="tag" title="Content about ZIP archive format and operations" class="tag_xPz1 tagRegular_FZN5" href="/keep-being-human-dev/blog/tags/zip/">ZIP</a></li><li class="tag_cZsL"><a rel="tag" title="Content related to performance optimization and techniques" class="tag_xPz1 tagRegular_FZN5" href="/keep-being-human-dev/blog/tags/performance/">Performance</a></li><li class="tag_cZsL"><a rel="tag" title="Content about code and performance optimization techniques" class="tag_xPz1 tagRegular_FZN5" href="/keep-being-human-dev/blog/tags/optimization/">Optimization</a></li><li class="tag_cZsL"><a rel="tag" title="Content related to Zlib compression library" class="tag_xPz1 tagRegular_FZN5" href="/keep-being-human-dev/blog/tags/zlib/">Zlib</a></li><li class="tag_cZsL"><a rel="tag" title="Content about streaming data processing and techniques" class="tag_xPz1 tagRegular_FZN5" href="/keep-being-human-dev/blog/tags/streaming/">Streaming</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/ruby-compression-tu-co-ban-den-nang-cao.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_t8pj" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Olft"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/keep-being-human-dev/blog/ruby-concurrency-mutexes-tu-co-ban-den-nang-cao/"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Ruby Concurrency &amp; Mutexes: Từ Cơ Bản Đến Nâng Cao - Hướng Dẫn Toàn Diện</div></a></nav></main><div class="col col--2"><div class="tableOfContents_ZllA thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tại-sao-cần-compression" class="table-of-contents__link toc-highlight">Tại Sao Cần Compression?</a></li><li><a href="#phần-1-cơ-bản---làm-quen-với-compression" class="table-of-contents__link toc-highlight">Phần 1: Cơ Bản - Làm Quen Với Compression</a><ul><li><a href="#11-nén-file-với-gzip" class="table-of-contents__link toc-highlight">1.1 Nén File Với Gzip</a></li><li><a href="#12-tạo-zip-archive" class="table-of-contents__link toc-highlight">1.2 Tạo ZIP Archive</a></li></ul></li><li><a href="#phần-2-trung-cấp---kỹ-thuật-nâng-cao" class="table-of-contents__link toc-highlight">Phần 2: Trung Cấp - Kỹ Thuật Nâng Cao</a><ul><li><a href="#21-nén-string-trong-memory" class="table-of-contents__link toc-highlight">2.1 Nén String Trong Memory</a></li><li><a href="#22-nén-và-giải-nén-file-streaming" class="table-of-contents__link toc-highlight">2.2 Nén và Giải Nén File Streaming</a></li></ul></li><li><a href="#phần-3-nâng-cao---kỹ-thuật-chuyên-nghiệp" class="table-of-contents__link toc-highlight">Phần 3: Nâng Cao - Kỹ Thuật Chuyên Nghiệp</a><ul><li><a href="#31-tạo-targz-archives" class="table-of-contents__link toc-highlight">3.1 Tạo TAR.GZ Archives</a></li><li><a href="#32-streaming-large-file-compression" class="table-of-contents__link toc-highlight">3.2 Streaming Large File Compression</a></li></ul></li><li><a href="#phần-4-expert-level---kỹ-thuật-chuyên-gia" class="table-of-contents__link toc-highlight">Phần 4: Expert Level - Kỹ Thuật Chuyên Gia</a><ul><li><a href="#41-custom-streaming-chunked-compression" class="table-of-contents__link toc-highlight">4.1 Custom Streaming Chunked Compression</a></li><li><a href="#42-multi-threaded-compression" class="table-of-contents__link toc-highlight">4.2 Multi-threaded Compression</a></li></ul></li><li><a href="#best-practices-và-lưu-ý" class="table-of-contents__link toc-highlight">Best Practices và Lưu Ý</a><ul><li><a href="#1-chọn-mức-độ-nén-phù-hợp" class="table-of-contents__link toc-highlight">1. Chọn Mức Độ Nén Phù Hợp</a></li><li><a href="#2-memory-management" class="table-of-contents__link toc-highlight">2. Memory Management</a></li><li><a href="#3-error-handling" class="table-of-contents__link toc-highlight">3. Error Handling</a></li><li><a href="#4-performance-tips" class="table-of-contents__link toc-highlight">4. Performance Tips</a></li></ul></li><li><a href="#kết-luận" class="table-of-contents__link toc-highlight">Kết Luận</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/keep-being-human-dev/docs/intro/">Tutorial</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink__HqX"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink__HqX"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink__HqX"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/keep-being-human-dev/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink__HqX"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>