"use strict";(self.webpackChunkkeep_being_human_dev=self.webpackChunkkeep_being_human_dev||[]).push([[17206],{33732:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>u,frontMatter:()=>c,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"rails/active_storage/expert/cdn_signed_url_with_custom_headers","title":"cdn_signed_url_with_custom_headers","description":"\ud83d\udd12 Securing & Optimizing URLs with CloudFront Signed URLs","source":"@site/docs/rails/active_storage/expert/cdn_signed_url_with_custom_headers.md","sourceDirName":"rails/active_storage/expert","slug":"/rails/active_storage/expert/cdn_signed_url_with_custom_headers","permalink":"/keep-being-human-dev/docs/rails/active_storage/expert/cdn_signed_url_with_custom_headers","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/rails/active_storage/expert/cdn_signed_url_with_custom_headers.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"async_variant_generation","permalink":"/keep-being-human-dev/docs/rails/active_storage/expert/async_variant_generation"},"next":{"title":"custom_pdf_page_count_analyzer","permalink":"/keep-being-human-dev/docs/rails/active_storage/expert/custom_pdf_page_count_analyzer"}}');var i=r(23420),s=r(65404);const c={},o=void 0,a={},d=[{value:"\ud83d\udd12 Securing &amp; Optimizing URLs with CloudFront Signed URLs",id:"-securing--optimizing-urls-with-cloudfront-signed-urls",level:2}];function l(e){const n={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"-securing--optimizing-urls-with-cloudfront-signed-urls",children:"\ud83d\udd12 Securing & Optimizing URLs with CloudFront Signed URLs"}),"\n",(0,i.jsx)(n.p,{children:"Replace default S3 presigned URLs with CloudFront signed URLs for low\u2011latency delivery and add custom headers for HSTS, caching or token validation."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Create a custom service inheriting from S3:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:"# lib/active_storage/service/cloudfront_service.rb\nrequire 'aws-sdk-cloudfront'\n\nclass ActiveStorage::Service::CloudFrontService < ActiveStorage::Service::S3Service\n  def url(key, **options)\n    signer = Aws::CloudFront::UrlSigner.new(\n      key_pair_id: ENV['CF_KEYPAIR_ID'],\n      private_key: ENV['CF_PRIVATE_KEY_PATH']\n    )\n    url = \"https://#{ENV['CF_DOMAIN']}/#{key}\"\n    signer.signed_url(url, expires: options[:expires_in] || 300)\n  end\nend\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsxs)(n.li,{children:["Register in ",(0,i.jsx)(n.code,{children:"config/storage.yml"}),":"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"cloudfront:\n  service: CloudFrontService\n  access_key_id: <%= ENV['S3_KEY'] %>\n  secret_access_key: <%= ENV['S3_SECRET'] %>\n  region: <%= ENV['AWS_REGION'] %>\n  bucket: <%= ENV['S3_BUCKET'] %>\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:"Use the new service and set security headers in your CDN or Rails middleware:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:"# config/environments/production.rb\nconfig.active_storage.service = :cloudfront\nRails.application.config.middleware.insert_before 0, Rack::ContentSecurityPolicy do |policy|\n  policy.default_src :self, :https\n  policy.img_src     :self, :https, ENV['CF_DOMAIN']\nend\n"})})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},65404:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>o});var t=r(36672);const i={},s=t.createContext(i);function c(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);